name: commit
on:
  push:
    branches: [ master ]

permissions:
  contents: write 

jobs:
  commit:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.PAT_TOKEN }}
    
    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh

    - name: Sync dependencies
      run: uv sync --all-extras
    
    - name: Execute & overwrite notebooks in-place
      run: |
        find notebooks -name "*.ipynb" | while read notebook; do
          echo "Executing & overwriting: $notebook"
          uv run papermill "$notebook" "$notebook" \
            --kernel python3 \
            --progress-bar 
        done
    
    - name: Commit as GitHub Bot
      run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add notebooks/
          git commit -m "Update notebooks [skip ci]" || exit 0

    - name: Push changes
      uses: ad-m/github-push-action@v0.8.0
      with:
        branch: master
        github_token: ${{ secrets.PAT_TOKEN }}
        repository: ${{ github.repository }}
        force_with_lease: true